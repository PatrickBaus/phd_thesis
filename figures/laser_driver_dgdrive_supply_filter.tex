\documentclass[svgnames]{standalone}
\usepackage{siunitx}
\usepackage[siunitx,europeanresistors,nooldvoltagedirection]{circuitikz}
\usetikzlibrary{calc,positioning,backgrounds,fit}

% Define constants here
\ctikzset{
  amplifiers/fill=cyan!25,
  sources/fill=green!70!black,
  diodes/fill=red,
  resistors/fill=blue!25,
}
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

% bare shape for the object.
\tikzset{regulatorshape/.style={muxdemux,
    muxdemux def={
        Lh=2, Rh=2, w=4,
        NL=1,NR=1,NT=0,NB=1,
    }
}}
% se manual section 3.4 "subcircuits"
\ctikzsubcircuitdef{lmTOS}{% TOS=three one seven, no numbers allowed here
    in, out, adj, center}{% anchors
    coordinate (#1-center)
    node [regulatorshape, anchor=center](#1-shape){} % main node
    % labels
    (#1-shape.north) node[font=\ttfamily\small, below]{LM317}
    (#1-shape.blpin 1)  node[font=\ttfamily\small, right]{in}
    (#1-shape.brpin 1)  node[font=\ttfamily\small, left]{out}
    (#1-shape.bbpin 1)  node[font=\ttfamily\small, above]{adj}
    % anchors
    (#1-shape.lpin 1) coordinate(#1-in)
    (#1-shape.bpin 1) coordinate(#1-adj)
    (#1-shape.rpin 1) coordinate(#1-out)
    % we are leaving the "current" position at the output
}
\ctikzsubcircuitactivate{lmTOS}

\begin{document}
    \begin{circuitikz}[
        american currents,
        american voltages,
        scale=0.7,
        transform shape,
        show background rectangle,
        background rectangle/.style={fill=gray!10, rounded corners, ultra thick,draw=gray},
    ]
        \tikzstyle{every node}=[font=\small]
        \tikzstyle{every node}=[font=\small]
        \begin{pgfonlayer}{foreground}
            \draw
                % positive rail
                (0,0) to[short, o-] ++(1,0) coordinate(vin+) ++(0,-6) coordinate(GND) -- ++(-1,0) node[ground]{}
                (vin+) to [L, l=\qty{1.2}{\mH}, name=Lin+] ++(2,0) coordinate(snubber+) to [eC, *-*, l=\qty{100}{\uF}, name=Cout+] (snubber+ |- GND)
                (snubber+) -- ++(2,0) coordinate(tmp) to[R, *-] ++(0,-3) to[eC, -*, l=\qty{390}{\uF}, name=Cout2+] (tmp |- GND) -- (GND)
                (tmp) -- ++(4,0) coordinate(tmp) node[pnp, anchor=E, rotate=90](Q1){} node[above] at (Q1) {Q1}
                (Q1.B) -- ++(0,-0.5) to[R, *-*] ++(-3,0) coordinate(tmp2) to[short, -*] (tmp2 |- tmp)
                (Q1.B) ++(0,-0.5) node[npn, anchor=C, rotate=90](Q2){} (Q2.E) to[short, -*] (Q2.E |- Q1.C) -- (Q1.C) node[above] at (Q2) {Q2}
                (Q2.B) -- ++(0,-0.5) to[R, *-] ++ (-2,0) to[leD, invert, mirror, name=led1] ++(-1.5,0) -| (tmp2)
                (Q2.B) ++(0,-0.5) -- ++(0,-1.5) coordinate(tmp) to[R] (tmp -| tmp2) to [short, -*] (tmp2 |- led1)
                (tmp) to[C, *-*, l=\qty{10}{\uF}] (tmp |- GND)
                (Q2.E |- Q1.C) -- ++(1,0) coordinate(tmp) to[eC, *-*, l=\qty{100}{\uF}] (tmp |- GND) -- (snubber+ |- GND)
                (tmp) to[short, -o] ++ (1,0)
                % negative rail
                (GND) ++(0,-6)  coordinate(vin-) to[short, -o] ++(-1,0)
                (vin-) to [L, l=\qty{1.2}{\mH}, name=Lin-] ++(2,0) coordinate(snubber-) to [eC, *-, l_=\qty{100}{\uF}, name=Cout+, invert] (snubber- |- GND)
                (snubber-) -- ++(2,0) coordinate(tmp) to[R, *-] ++(0,3) to[eC, l_=\qty{390}{\uF}, name=Cout2+, invert] (tmp |- GND)
                (tmp) -- ++(4,0) coordinate(tmp) node[npn, anchor=E, rotate=-90](Q3){}
                (Q3.B) -- ++(0,0.5) to[R, *-*] ++(-3,0) coordinate(tmp2) to[short, -*] (tmp2 |- tmp) node[below] at (Q3) {Q3}
                (Q3.B) ++(0,0.5) node[pnp, anchor=C, rotate=-90](Q4){} (Q4.E) to[short, -*] (Q4.E |- Q3.C) -- (Q3.C) node[below] at (Q4) {Q4}
                (Q4.B) -- ++(0,0.5) to[R, *-] ++ (-2,0) to[leD, name=led2] ++(-1.5,0) -| (tmp2)
                (Q4.B) ++(0,0.5) -- ++(0,1.5) coordinate(tmp) to[R] (tmp -| tmp2) to [short, -*] (tmp2 |- led2)
                (tmp) to[C, *-, l_=\qty{10}{\uF}] (tmp |- GND)
                (Q4.E |- Q3.C) -- ++(1,0) coordinate(tmp) to[eC, *-, l_=\qty{100}{\uF}, invert] (tmp |- GND) -- (snubber- |- GND)
                (tmp) to[short, -o] ++ (1,0)
            ;
        \end{pgfonlayer}
        \begin{pgfonlayer}{main}
            %\node[draw=red!80!black, fill=red!20, rounded corners=2pt, fit={(Cin+) (Lin+) (Lin-)}](filter){};
            %\node[black, above, align=center] at (filter.north) {Supply filter};
        \end{pgfonlayer}
    \end{circuitikz}
\end{document}
